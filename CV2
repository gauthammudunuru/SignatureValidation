import cv2
import numpy as np
from PIL import Image
import matplotlib.pyplot as plt

def show_image(img, title=""):
    plt.figure(figsize=(8,10))
    plt.imshow(img)
    plt.axis("off")
    if title:
        plt.title(title)
    plt.show()

# Convert PIL page to OpenCV
page_img = np.array(pages[0])
img_cv = cv2.cvtColor(page_img, cv2.COLOR_RGB2BGR)
gray = cv2.cvtColor(img_cv, cv2.COLOR_BGR2GRAY)

# Apply slight blur to reduce noise
blur = cv2.GaussianBlur(gray, (5,5), 0)

# Edge detection
edges = cv2.Canny(blur, 50, 150)

# Find contours
contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

# Filter contours that are rectangular-ish
rect_contours = []
for c in contours:
    approx = cv2.approxPolyDP(c, 0.02*cv2.arcLength(c, True), True)
    if len(approx) == 4:  # rectangle has 4 corners
        x, y, w, h = cv2.boundingRect(approx)
        # optional: filter small boxes
        if w*h > 1000:  
            rect_contours.append((x,y,w,h))

print(f"Detected {len(rect_contours)} rectangle(s)")

# Draw rectangles for visualization
img_boxes = img_cv.copy()
for x, y, w, h in rect_contours:
    cv2.rectangle(img_boxes, (x, y), (x+w, y+h), (0,0,255), 2)  # red boxes

show_image(cv2.cvtColor(img_boxes, cv2.COLOR_BGR2RGB), "Detected Rectangles")

for i, (x, y, w, h) in enumerate(rect_contours):
    cropped = pages[0].crop((x, y, x+w, y+h))
    show_image(cropped, f"Cropped Box {i+1}")
    cropped.save(f"page1_box_{i+1}.png")




####

import easyocr
reader = easyocr.Reader(['en'])
for i, (x,y,w,h) in enumerate(rect_contours):
    cropped = np.array(pages[0].crop((x,y,x+w,y+h)))
    text = reader.readtext(cropped, detail=0)
    print(f"Box {i+1} OCR Text:", text)

###

import pytesseract

# Filter rectangles with any text
text_boxes = []

for i, (x, y, w, h) in enumerate(rect_contours):
    cropped = pages[0].crop((x, y, x+w, y+h))
    
    # OCR the box
    text = pytesseract.image_to_string(cropped)
    
    if len(text.strip()) > 0:
        # This box contains text
        text_boxes.append((x, y, w, h))
        show_image(cropped, f"Text Box {len(text_boxes)}")

