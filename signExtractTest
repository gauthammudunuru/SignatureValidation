import base64
import io
from PIL import Image
import matplotlib.pyplot as plt
from goldmansachs.openai import OpenAI

client = OpenAI()

# ==============================
# Convert PIL to data URL string
# ==============================
def pil_to_data_url(pil_img, max_size=512):
    img_copy = pil_img.copy()
    img_copy.thumbnail((max_size, max_size))  # downscale
    buf = io.BytesIO()
    img_copy.save(buf, format="PNG", optimize=True)
    b64 = base64.b64encode(buf.getvalue()).decode("utf-8")
    return f"data:image/png;base64,{b64}"

# ==============================
# LLM call for handwritten signature
# ==============================
def extract_handwritten_signature_structured(pil_img):
    data_url = pil_to_data_url(pil_img)
    
    # Build structured message
    messages = [
        {"type": "text", "role": "user",
         "content": "Extract only the handwritten signature portions. Return a cropped PNG image containing only the handwriting in base64. Return JSON only with {'handwritten_signature': '<base64>'}."},
        {"type": "image", "role": "user", "image_url": data_url}
    ]
    
    try:
        response = client.chat.completion.create(
            model="Qwen3-omni",
            messages=messages
        )
        content = response.choices[0].message.content.strip()
        import json
        return json.loads(content).get("handwritten_signature", "")
    except Exception as e:
        print("LLM call failed:", e)
        return ""

# ==============================
# Process final_crops (entropy < 2)
# ==============================
handwritten_results = []
for item in final_crops:
    if item["entropy"] < 2.0:
        # Convert to binary for better context
        gray = item["image"].convert("L")
        binary = gray.point(lambda x: 0 if x<128 else 255)
        sig_b64 = extract_handwritten_signature_structured(binary)
        handwritten_results.append({
            "page": item["page"],
            "bbox": item["bbox"],
            "signature_b64": sig_b64
        })

# ==============================
# Display extracted signatures
# ==============================
for r in handwritten_results:
    plt.figure(figsize=(4,4))
    sig_b64 = r["signature_b64"]
    if sig_b64:
        sig_img = Image.open(io.BytesIO(base64.b64decode(sig_b64)))
        plt.imshow(sig_img)
    else:
        plt.text(0.5,0.5,"No signature extracted", ha="center")
    plt.axis("off")
    plt.title(f"P{r['page']} | bbox={r['bbox']}")
    plt.show()
